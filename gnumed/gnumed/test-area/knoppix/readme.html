<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>Remastering Knoppix</title>
  <meta http-equiv="content-type"
 content="text/html; charset=ISO-8859-1">
</head>
<body>
<div align="center">
<h1>How-to remaster Knoppix to include GNUmed and other med software</h1>
Date of revision: 2002-11-13<br>
Author: Jubal John (jubaljTAmetahelpTODcoTODnz), <br>
Last Edited: Jubal John<br>
<br>
<h2 align="left">Introduction</h2>
<div align="justify">Knoppix is a self-configuring CD based debian distro.
More information can be found here: <a
 href="http://www.knopper.net/knoppix/index-en.html">http://www.knopper.net/knoppix/index-en.html</a>.
It is an ideal platform to develop demo CD's from, because of its good autodetection
and because it runs completely of the CD. It uses a transparent compression
<a href="http://www.knopper.net/download/knoppix/cloop.README">technology</a>
to fit close to 2 GB of data on a 700MB CD. A good bonus feature of the CD
is that it can easily be installed onto the computer with <a
 href="http://www.freenet.org.nz/misc/knoppix-install.html">knx-hdinstall</a>.<br>
<br>
<h2>The process</h2>
<h3>Step 1: Getting the data off the knoppix CD</h3>
Remastering the CD involves creating a partition (or two) which can be used
to store the uncompressed CD, to modifying it and then to recompress and
test it. I will assume that two seperate partitions are being used, although
you could just use seperate directories on a free partition with sufficient
space. In addition to space for the data, <i>a large swap partition</i> is
required for the step which involves creating the compressed file - I'm not
sure what the minimum size of this partition is but it needs to be about
2GB.<br>
<br>
If you have setup two partitions for the data, one will act as a <b>source</b>
and the second will act as the the <b>master</b> (or you may use two seperate
directories named appropriately).<br>
<br>
<b>Source (contents of main compressed file):</b> This contains the <i>files
that form the compressed part</i> of the Knoppix cd - which is basically
most of the knoppix files. We will be <i>chroot</i>ing to this directory
to make the desired changes.<br>
<br>
<b>Master (used to make final iso):</b> This directory contains the files
as they should appear in a knoppix cd, ie. it contains the files that make
the CD bootable + a big file called KNOPPIX which is a compressed version
of everything contained in the source directory.<br>
<br>
<blockquote>
  <h4><font color="#009900"><a
 href="http://savannah.gnu.org/cgi-bin/viewcvs/gnumed/gnumed/gnumed/test-area/knoppix/rip-cd.sh?rev=1.1&amp;content-type=text/vnd.viewcvs-markup">rip-cd.sh</a>
script</font></h4>
</blockquote>
<blockquote>This script is useful if you have already setup three partitions,
that are ready to be used as source, master and swap. Note: this is a <font
 color="#990000">dangerous</font> script and you need to edit it to let it
know which partitions you have setup for various purposes, also make sure
you understand all the commands that the script is executing.<br>
</blockquote>
<blockquote>This script needs to be run from a root console (ctrl-alt-F1)
after you have <i>booted from the Knoppix cd</i> that you want to remaster.
The script will basically copy all the stuff of the CD onto your hard disk
so that you are ready to make the desired changes.<br>
</blockquote>
<h3>Step 2: Making the changes</h3>
The final thing that the previous script does is chroot to the source. This
now allows you to mount proc, edit sources.list, edit /etc/resolv.conf and
do an apt-get update etc. Basically now you are free to tailor knoppix to
your requirement.
<h4>Setting up gnu-med</h4>
Get the dependencies (install any additional things that it wants to install):
<br>
<blockquote><small><b><font face="Helvetica, Arial, sans-serif">apt-get install
postgresql python2.2-psycopg</font></b>; </small><br>
</blockquote>
<blockquote><small><font face="Helvetica, Arial, sans-serif"><b>apt-get -t
unstable install libwxgtk2.3-python python-pgsql</b></font></small><small>
  </small><br>
</blockquote>
Get gnumed from the CVS (then copy it to the standard location /usr/share/gnumed
(just need client and server subdirectories))<br>
<blockquote><font face="Helvetica, Arial, sans-serif"><small><b>cvs -d:pserver:anoncvs@subversions.gnu.org:/cvsroot/gnumed
login</b></small></font><br>
</blockquote>
<blockquote><font face="Helvetica, Arial, sans-serif"><small><b>cvs -z9 -d:pserver:anoncvs@subversions.gnu.org:/cvsroot/gnumed
co gnumed</b></small></font><br>
</blockquote>
Export GNUMED_DIR (/usr/share/gnumed/client) variable for user knoppix<br>
Gnumed can be run by typing <font face="Helvetica, Arial, sans-serif"><small><b>python2.2
gnumed.py</b></small></font> in the /usr/share/gnumed/client/wxpython/ directory.
[you need to have setup postgresql and then have booted from your new remastered
knoppix to test if this works]<br>
<h4>Setting up postgresql</h4>
Apt-get would have setup postgresql but to to get it to work correctly in
knoppix a few things have to be done.<br>
<blockquote><b>Allowing write access to database</b><br>
A script like <a
 href="http://savannah.gnu.org/cgi-bin/viewcvs/gnumed/gnumed/gnumed/test-area/knoppix/debian-med?rev=1.1&amp;content-type=text/vnd.viewcvs-markup"><b><font
 color="#009900">debian-med</font></b></a> placed in /etc/init.d with a symlink
to it /etc/rc5.d/S19debian-med (<b><font
 face="Helvetica, Arial, sans-serif"><small>ln -s /etc/init.d/debian-med
/etc/rc5.d/S19debian-med</small></font></b>) allows for the execution of
any initiallisation steps while the knoppix CD starts up. To make the database
work correctly, the script removes the symlinks to the CD that exist in the
/var/lib/postgres/data directory with a copy of the real files (<font
 face="Helvetica, Arial, sans-serif"><b><small>rm -rf /var/lib/postgres/;
cp -Rp /KNOPPIX/var/lib/postgres /var/lib/</small></b></font>)<br>
  <br>
  <b>Creating users/database</b><br>
Once you have the database working, you need to run the createdb scripts
the in the gnumed/server directory and also createuser knoppix and guest.<br>
  <br>
  <b>Authentication</b><br>
Since this is just a demo cd, /etc/postgresql/pg_hba.conf can be edited to
allow access without authentication by changing 'indent sameuser or reject'
to 'trust'<br>
</blockquote>
<b>Setting up Apache</b><br>
<br>
If the medical software requires the apache webserver like odontolinux; you
could do a <font face="Helvetica, Arial, sans-serif"><b><small>ln -s /etc/init.d/apache
/etc/rc5.d/S20apache</small></b></font> so that apache starts up on knoppix
startup.<br>
<blockquote><b><font color="#009900"><br>
  <br>
  <a
 href="http://savannah.gnu.org/cgi-bin/viewcvs/gnumed/gnumed/gnumed/test-area/knoppix/changes.sh?rev=1.1&amp;content-type=text/vnd.viewcvs-markup">changes.sh</a>
script<br>
  </font></b><br>
This<b> </b>is not really a script at the moment, more a checklist of sorts..
so dont execute it. You might just want to leave it open on a virtual console
if you need something to prompt you on what needs to be done.. (I need to
improve it by including a generic 'apt-get remove' line to remove unwanted
software from the knoppix cd to create space for the stuff we have added)<br>
</blockquote>
<h3>Step 3: Testing the remastered CD</h3>
Fortunately you dont need to create a cd everytime you need to test your
changes, you can just use the knoppix boot floppy. It can be created by a
command similar to:
<blockquote>
  <pre><font face="Helvetica, Arial, sans-serif"><b>dd if=/mnt/master/KNOPPIX/boot.img of=/dev/fd0 </b></font></pre>
</blockquote>
The boot floppy will start up and look for the the hard disk partition which
contains a KNOPPIX directory (make sure its using the partition with the
<b>master</b> files). If you have used a partition for source, it will also
contain a KNOPPIX directory that you will need to rename (if its partition
number comes first.. the floppy searches hda1, a2, a3, b1, b2, b3 etc...
and uses first partition with a KNOPPIX directory)<br>
<br>
Now, before we can actually boot the remaster knoppix we need to create the
compressed KNOPPIX file in the master directory/partition. I can do this
step from within RH8 after i've copied create_compressed_fs (/mnt/source/usr/bin/create_compressed_fs)
into my path.<br>
<br>
<blockquote><font color="#009900"><b><a
 href="http://savannah.gnu.org/cgi-bin/viewcvs/gnumed/gnumed/gnumed/test-area/knoppix/testknoppix.sh?rev=1.1&amp;content-type=text/vnd.viewcvs-markup">testknoppix.sh</a>
script</b></font><br>
  <br>
This script &nbsp;if setup correctly will create the compressed KNOPPIX file
in the master partition so that if you reboot with the knoppix floopy in
your drive you will be greeted with the remastered version of your knoppix.<br>
  <br>
Now if things aren't up to scratch you'll need to go back to the chrooted
enviroment to make any changes - you can do this in one of the knoppix root
consoles. You might be able to get away by making some changes by being chrooted
from within the usual linux you are using. eg, I can chroot from RH8 to make
any minor changes and then run the testknoppix.sh script.<br>
  <br>
</blockquote>
<h3>Step 4: Making the final iso</h3>
Ah.. so u made it this far. Just make sure you do an <font
 face="Helvetica, Arial, sans-serif"><small><b>apt-get clean</b></small></font>
and an <font face="Helvetica, Arial, sans-serif"><small><b>updatedb</b></small></font>
when you are chrooted to clean up things. Rest is quite straight forward
(have a look at the script)<br>
<b><br>
</b>
<blockquote><b><font color="#009900"><a
 href="http://savannah.gnu.org/cgi-bin/viewcvs/gnumed/gnumed/gnumed/test-area/knoppix/make-iso.sh?rev=1.1&amp;content-type=text/vnd.viewcvs-markup">make-iso.sh</a>
script</font></b><br>
  <br>
Removes the ogg files and makes the iso...<br>
  <br>
</blockquote>
<h2>References / other useful links:</h2>
<a href="http://www.linux.net.nz/lists/NZLUG/2002/08/0609.html">http://www.linux.net.nz/lists/NZLUG/2002/08/0609.html</a><br>
 <a
 href="http://alamo.satlug.org/pipermail/satlug/2002-August/004254.html">http://www.geocities.com/ted_johnson2/knoppix.txt<br>
http://alamo.satlug.org/pipermail/satlug/2002-August/004254.html</a><br>
<a
 href="http://www.linuxtag.org/cgi-bin/yabb/YaBB.pl?board=knoppix-en;action=display;num=1025275154">http://www.linuxtag.org/cgi-bin/yabb/YaBB.pl?board=knoppix-en;action=display;num=1025275154</a><br>
<br>
<h2>Disclaimer</h2>
Standard disclaimers apply. I am in no way responsible for any loss of information
or other damage that you may suffer as a consequence of reading this material
or using any scripts. <b>USE AT OWN RISK</b>.<br>
<br>
I am happy to hear suggestions on any improvements to scripts / content.<br>
</div>
</div>
</body>
</html>
